name: ckb-dao-vote

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - name: Install llvm 19
      shell: bash
      run: |
        sudo apt-get purge --auto-remove llvm python3-lldb-14 llvm-14
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 19
        rm llvm.sh
    - name: Fix llvm-ar path
      shell: bash
      run: |
        sudo ln -s $(which llvm-ar-19) /usr/bin/llvm-ar || true
        sudo ln -s $(which llvm-objcopy-19) /usr/bin/llvm-objcopy || true
        sudo ln -s $(which ld.lld-19) /usr/bin/ld.lld || true
    - name: Install rust target
      run: rustup target add riscv64imac-unknown-none-elf
    - name: Install rustfmt
      run: rustup component add rustfmt
    - name: Check formatting
      run: cargo fmt -- --check
    - name: Make on-chain script
      run: make build
    - name: Make on-chain script with log
      run: make build CARGO_ARGS="--features enable_log"
    - name: Cargo test
      run: make test CARGO_ARGS="-- --nocapture"
